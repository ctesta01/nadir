<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Density Estimation • nadir</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.0/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Density Estimation">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nadir</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Basic-Examples.html">Basic Examples</a></li>
    <li><a class="dropdown-item" href="../articles/Benchmarking.html">Benchmarking Against `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Binary-and-Multiclass-Outcomes.html">Binary and Multiclass Outcomes</a></li>
    <li><a class="dropdown-item" href="../articles/Clustered-Data.html">Clustered and Dependent Data</a></li>
    <li><a class="dropdown-item" href="../articles/comparison_to_SuperLearner.html">Comparison to `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Creating-Learners.html">Creating Learners</a></li>
    <li><a class="dropdown-item" href="../articles/currying_closures_and_function_factories.html">Currying, Closures, and Function Factories</a></li>
    <li><a class="dropdown-item" href="../articles/Density-Estimation.html">Density Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Doubly-Robust-Estimation.html">Doubly Robust Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Error-Handling.html">Error Handling</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/Guidance-for-Developers.html">Guidance for Developers</a></li>
    <li><a class="dropdown-item" href="../articles/Running-super_learner-in-Parallel.html">Running `super_learner()` in Parallel</a></li>
    <li><a class="dropdown-item" href="../articles/Survival.html">Survival Analysis via Pooled Logistic Regression</a></li>
    <li><a class="dropdown-item" href="../articles/Using-Weights.html">Using Observation Weights</a></li>
    <li><a class="dropdown-item" href="../articles/Visualizing-Performance.html">Visualizing Performance</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ctesta01/nadir/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Density Estimation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ctesta01/nadir/blob/HEAD/vignettes/articles/Density-Estimation.Rmd" class="external-link"><code>vignettes/articles/Density-Estimation.Rmd</code></a></small>
      <div class="d-none name"><code>Density-Estimation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ctesta01.github.io/nadir/">nadir</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Registered S3 method overwritten by 'future':</span></span>
<span><span class="co">#&gt;   method               from      </span></span>
<span><span class="co">#&gt;   all.equal.connection parallelly</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'ggplot2' was built under R version 4.3.3</span></span></code></pre></div>
<!-- 
NOTES FOR AUTHORS:
Given the intent to apply super_learner() in causal settings, would it be
useful to go through this replacing "outcome" with "exposure/treatment" 
and add a notice at the top? 
Similarly, predictors == covariates or confounders. 
-->
<p>Thinking about applications of the super learner algorithm to causal
inference, one key application is through modeling the
treatment/exposure mechanism.</p>
<p>In many cases, the treatment/exposure is continuous, necessitating
the estimation of a “generalized” propensity score — generalized in the
sense that the treatment/exposure is no longer binary but continuous,
and hence our propensity score model is a probability density model for
a continuous range of exposure values rather than just the probability
of a binary treatment/no-treatment variable.</p>
<p>Here we demonstrate the application of
<code><a href="../reference/super_learner.html">nadir::super_learner()</a></code> in estimating such generalized
propensity scores.</p>
<p>The following examples are provided in the spirit of showing a myriad
number of ways <a href="https://ctesta01.github.io/nadir/">nadir</a> can be used to tackle density
estimation.</p>
<div class="section level2">
<h2 id="basic-syntax-for-fitting-density-models">Basic Syntax for Fitting Density Models<a class="anchor" aria-label="anchor" href="#basic-syntax-for-fitting-density-models"></a>
</h2>
<p>To fit a conditional density model, we need a few things:</p>
<ul>
<li>a dataset</li>
<li>to select the outcome, and predictor variables (which together
define a formula)</li>
<li>a collection of candidate learners</li>
<li>and to use the negative log loss function in the super learner
algorithm for choosing among the learners.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># specify our data and regression problem </span></span>
<span><span class="co"># ---------------------------------------</span></span>
<span></span>
<span><span class="co"># in order to build a weighting based estimator, we might fit a conditional</span></span>
<span><span class="co"># density model of our continuous exposure </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"Boston"</span>, package <span class="op">=</span> <span class="st">"MASS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we're going to regress the crime measurement variable in the Boston dataset</span></span>
<span><span class="co"># on all the other variables. </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># and we want to control for the following potential confounders (all other variables in the Boston dataset) </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># so we want to regress crime on all the other variables in the Boston dataset </span></span>
<span><span class="va">reg_formula</span> <span class="op">&lt;-</span> <span class="va">crim</span> <span class="op">~</span> <span class="va">.</span> </span>
<span></span>
<span></span>
<span><span class="co"># specify a collection of candidate learners</span></span>
<span><span class="co"># ------------------------------------------</span></span>
<span></span>
<span><span class="co"># we'll use a normal error model with a linear conditional mean model, </span></span>
<span><span class="co"># and random forest, ranger, lm, and earth with kernel bandwidth density() models for the </span></span>
<span><span class="co"># error distribution</span></span>
<span></span>
<span><span class="co"># nadir provides the helper function lnr_homoskedastic_density that can be used</span></span>
<span><span class="co"># to build a homoskedastic density learner out of a given conditional mean learner.</span></span>
<span></span>
<span><span class="va">lnr_rf_homoskedastic_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/lnr_homoskedastic_density.html">lnr_homoskedastic_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, mean_lnr <span class="op">=</span> <span class="va">lnr_rf</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lnr_ranger_homoskedastic_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/lnr_homoskedastic_density.html">lnr_homoskedastic_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, mean_lnr <span class="op">=</span> <span class="va">lnr_ranger</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lnr_lm_homoskedastic_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/lnr_homoskedastic_density.html">lnr_homoskedastic_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, mean_lnr <span class="op">=</span> <span class="va">lnr_lm</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lnr_earth_homoskedastic_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/lnr_homoskedastic_density.html">lnr_homoskedastic_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, mean_lnr <span class="op">=</span> <span class="va">lnr_earth</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we recommend setting the sl_lnr_type attribute to avoid warnings from super_learner()</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># this tells the super_learner() function that these learners are designed</span></span>
<span><span class="co"># to work with density estimation problems.</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># without this, users will see a friendly warning asking them if they're sure </span></span>
<span><span class="co"># they want to use the given learners with the outcome_type = 'density'.</span></span>
<span><span class="co"># </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">lnr_rf_homoskedastic_density</span>, <span class="st">'sl_lnr_type'</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">'density'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">lnr_ranger_homoskedastic_density</span>, <span class="st">'sl_lnr_type'</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">'density'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">lnr_lm_homoskedastic_density</span>, <span class="st">'sl_lnr_type'</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">'density'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">lnr_earth_homoskedastic_density</span>, <span class="st">'sl_lnr_type'</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">'density'</span></span>
<span></span>
<span></span>
<span><span class="co"># super learning: </span></span>
<span><span class="co"># choosing weights for candidate learners and ensembling</span></span>
<span><span class="co"># ======================================================</span></span>
<span></span>
<span><span class="va">learned_sl_density_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">Boston</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">reg_formula</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    normal <span class="op">=</span> <span class="va">lnr_lm_density</span>,</span>
<span>    ranger <span class="op">=</span> <span class="va">lnr_ranger_homoskedastic_density</span>,</span>
<span>    earth <span class="op">=</span> <span class="va">lnr_earth_homoskedastic_density</span>,</span>
<span>    lm <span class="op">=</span> <span class="va">lnr_lm_homoskedastic_density</span></span>
<span>    <span class="op">)</span>,</span>
<span>  outcome_type <span class="op">=</span> <span class="st">'density'</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># if you prefer not to code up the new learners as above, another way to perform</span></span>
<span><span class="co"># the same super learning as above is to use the `extra_learner_args` option</span></span>
<span><span class="co"># with named learners as follows:</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># learned_sl_density_model &lt;- super_learner(</span></span>
<span><span class="co">#   data = Boston,</span></span>
<span><span class="co">#   formula = reg_formula,</span></span>
<span><span class="co">#   learners = list(</span></span>
<span><span class="co">#     normal = lnr_lm,</span></span>
<span><span class="co">#     ranger = lnr_homoskedastic_density,</span></span>
<span><span class="co">#     earth = lnr_homoskedastic_density,</span></span>
<span><span class="co">#     lm = lnr_lm_homoskedastic_density</span></span>
<span><span class="co">#     ),</span></span>
<span><span class="co">#   extra_learner_args = list(</span></span>
<span><span class="co">#     ranger = list(mean_lnr = lnr_ranger),</span></span>
<span><span class="co">#     earth = list(mean_lnr = lnr_earth),</span></span>
<span><span class="co">#     lm = list(mean_lnr = lnr_lm)),</span></span>
<span><span class="co">#   outcome_type = 'density',</span></span>
<span><span class="co">#   verbose = TRUE</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># one reason it can be useful to create the learners explicitly is to be able to</span></span>
<span><span class="co"># visualize and debug their behaviors individually.</span></span>
<span></span>
<span></span>
<span><span class="co"># fit diagnostics</span></span>
<span><span class="co"># ===============</span></span>
<span></span>
<span><span class="co"># two things we might want to do with a fit super learner model are:</span></span>
<span><span class="co"># 1) see how each candidate learner performed with regard to the specified loss</span></span>
<span><span class="co">#    function</span></span>
<span><span class="co"># 2) see the weights assigned to each learner (how favored they are in the final</span></span>
<span><span class="co">#    ensemble model).</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># to be able to see these diagnostics, it's important that super_learner() is</span></span>
<span><span class="co"># run with vebose = TRUE otherwise these extra details are not stored in the </span></span>
<span><span class="co"># output object. </span></span>
<span></span>
<span><span class="co"># 1) compare the learners using negative log likelihood loss</span></span>
<span><span class="fu"><a href="../reference/compare_learners.html">compare_learners</a></span><span class="op">(</span><span class="va">learned_sl_density_model</span>, loss_metric <span class="op">=</span> <span class="va">negative_log_loss</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   normal ranger earth    lm</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">1</span>716.  <span style="text-decoration: underline;">1</span>055. <span style="text-decoration: underline;">1</span>403. <span style="text-decoration: underline;">1</span>473.</span></span>
<span></span>
<span><span class="co"># 2) see the weights given to each candidate learner</span></span>
<span><span class="va">learned_sl_density_model</span><span class="op">$</span><span class="va">learner_weights</span></span>
<span><span class="co">#&gt;     normal     ranger      earth         lm </span></span>
<span><span class="co">#&gt; 0.07190413 0.87099445 0.02994368 0.02715774</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="lets-validate-that-conditional-density-works-the-way-it-should">Let’s validate that conditional density works the way it should<a class="anchor" aria-label="anchor" href="#lets-validate-that-conditional-density-works-the-way-it-should"></a>
</h2>
<p>One test we can do to check that conditional density estimation is
working correctly is that once we condition on a set of predictors, the
produced probability density function should integrate to 1 – that is,
its area under the curve should be equal to 1.</p>
<p>We show an example of a test here:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lm_density_predict</span> <span class="op">&lt;-</span> <span class="fu">lnr_lm_homoskedastic_density</span><span class="op">(</span><span class="va">Boston</span>, <span class="va">reg_formula</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">Boston</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ys</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[[</span><span class="st">'crim'</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="fu">lm_density_predict</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">f_lm</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, subdivisions <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.981094 with absolute error &lt; 6.9e-05</span></span>
<span></span>
<span></span>
<span><span class="va">earth_density_predict</span> <span class="op">&lt;-</span> <span class="fu">lnr_earth_homoskedastic_density</span><span class="op">(</span><span class="va">Boston</span>, <span class="va">reg_formula</span>, density_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bw <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f_earth</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">Boston</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ys</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[[</span><span class="st">'crim'</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="fu">earth_density_predict</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">earth_density_predict</span><span class="op">(</span><span class="va">Boston</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.01315833</span></span>
<span></span>
<span><span class="co"># we're looking for this number to be very close to 1:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">f_earth</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.9987836 with absolute error &lt; 5.4e-05</span></span>
<span></span>
<span></span>
<span><span class="co"># sometimes if integrate() has trouble, it's useful to perform the integration by hand:</span></span>
<span><span class="va">y_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="va">delta_y</span> <span class="op">&lt;-</span> <span class="va">y_seq</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">y_seq</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">f_earth</span><span class="op">(</span><span class="va">y_seq</span><span class="op">)</span><span class="op">*</span><span class="va">delta_y</span><span class="op">)</span> <span class="co"># we're looking for this to be close to 1</span></span>
<span><span class="co">#&gt; [1] 0.9987911</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="heteroskedastic-learners">Heteroskedastic Learners<a class="anchor" aria-label="anchor" href="#heteroskedastic-learners"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lnr_earth_mean_glm_var_heteroskedastic_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/lnr_heteroskedastic_density.html">lnr_heteroskedastic_density</a></span><span class="op">(</span></span>
<span>    <span class="va">data</span>,</span>
<span>    <span class="va">formula</span>,</span>
<span>    mean_lnr <span class="op">=</span> <span class="va">lnr_earth</span>,</span>
<span>    var_lnr <span class="op">=</span> <span class="va">lnr_lm</span>,</span>
<span>    density_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bw<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">Boston</span><span class="op">$</span><span class="va">log_crim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span></span>
<span></span>
<span><span class="va">earth_mean_glm_var_heteroskedastic_predict</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">lnr_earth_mean_glm_var_heteroskedastic_density</span><span class="op">(</span><span class="va">Boston</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">log_crim</span> <span class="op">~</span> <span class="va">medv</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">earth_mean_glm_var_heteroskedastic_predict</span><span class="op">(</span><span class="va">Boston</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.07019618</span></span>
<span></span>
<span><span class="va">f_earth_glm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">Boston</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ys</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[[</span><span class="st">'log_crim'</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="fu">earth_mean_glm_var_heteroskedastic_predict</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># check that the estimated density has area-under-the-curve = 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span></span>
<span>  <span class="va">f_earth_glm</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">log_crim</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">log_crim</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">log_crim</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">log_crim</span><span class="op">)</span>,</span>
<span>  subdivisions <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.590631 with absolute error &lt; 0.00015</span></span>
<span></span>
<span><span class="co"># create a grid to predict densities over</span></span>
<span><span class="va">prediction_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  log_crim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  medv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">medv</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">medv</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate densities for every grid-point</span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">earth_mean_glm_var_heteroskedastic_predict</span><span class="op">(</span></span>
<span>  <span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize the density model across a grid of outcomes and predictors</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Boston</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">medv</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_crim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Heteroskedastic Density Estimation Model"</span>, </span>
<span>          <span class="st">"(Mean model: earth, Variance model: GLM)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The above example is in 2D (e.g., one predictor and one outcome
variable), but in practical settings we may be estimating the density
for one variable conditional on many other variables. The syntax easily
extends as follows, recalling that <code>reg_formula</code> was
instantiated above as ~, crim, ..</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lnr_earth_glm_heteroskedastic_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/lnr_heteroskedastic_density.html">lnr_heteroskedastic_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, mean_lnr <span class="op">=</span> <span class="va">lnr_earth</span>, </span>
<span>                            var_lnr <span class="op">=</span> <span class="va">lnr_mean</span>, </span>
<span>                            density_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bw <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>                            <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lnr_earth_glm_heteroskedastic_predict</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">lnr_earth_glm_heteroskedastic_density</span><span class="op">(</span><span class="va">Boston</span>, <span class="va">reg_formula</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">lnr_earth_glm_heteroskedastic_predict</span><span class="op">(</span><span class="va">Boston</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1280906</span></span>
<span></span>
<span><span class="va">f_earth_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">Boston</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ys</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[[</span><span class="st">'crim'</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="fu">lnr_earth_glm_heteroskedastic_predict</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">f_earth</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Boston</span><span class="op">$</span><span class="va">crim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.6147477 with absolute error &lt; 5.8e-05</span></span></code></pre></div>
<p>We’ve omitted visualizing what the predictions look like for this
model. In general, while it can be useful to spot check whether or not
integration is working correctly, or if certain heuristics hold, it can
be hard to reason about how a 2D slice of a higher dimensional
conditional density model should appear.</p>
<p>For example, some intuition that begins to fail in higher dimensional
conditional density models is that the density should be higher where
the data points are clustered: if one conditions on a set of all but 2
parameter values and visualizes a grid like in the above example for the
remaining predictor and outcome variables, the set of variables
conditioned on may be more consistent with higher density in a region
outside the bulk of the data distribution if the conditioning set is
more consistent with outliers.</p>
<p>In general, this is why for higher dimensional models, we prefer to
rely on checks like “does the density integrate to 1?” after
conditioning on a full set of predictors and integrating over the
possible values of the outcome.</p>
</div>
<div class="section level2">
<h2 id="d-density-estimation">2D Density Estimation<a class="anchor" aria-label="anchor" href="#d-density-estimation"></a>
</h2>
<p>Perhaps visualizing density estimation in 2-to-3 dimensions will help
people understand what’s going on.</p>
<p>Suppose our regression problem is to regress flipper length on bill
depth from the palmer penguins dataset. We’ll fit some conditional
density models and visualize their predictions.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://allisonhorst.github.io/palmerpenguins/" class="external-link">palmerpenguins</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MetBrewer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">penguins</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'flipper_length_mm'</span>, <span class="st">'bill_depth_mm'</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># conditional normal example:</span></span>
<span></span>
<span><span class="va">learned_conditional_normal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lnr_lm_density.html">lnr_lm_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">172</span>, <span class="fl">231</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  bill_depth_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">13.1</span>, <span class="fl">21.5</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_conditional_normal</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Conditionally Normal Density Model"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-1.png" width="2400"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># earth and stats::density</span></span>
<span></span>
<span><span class="va">learned_earth_homoskedastic_density</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">lnr_earth_homoskedastic_density</span><span class="op">(</span><span class="va">data</span>, <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_earth_homoskedastic_density</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Using earth::earth for conditional mean and stats::density for error"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-2.png" width="2400"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># randomForest and stats::density</span></span>
<span></span>
<span><span class="va">learned_rf_homoskedastic_density</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">lnr_rf_homoskedastic_density</span><span class="op">(</span><span class="va">data</span>, <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_rf_homoskedastic_density</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Using randomForest::randomForest for conditional mean and stats::density for error"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-3.png" width="2400"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># ranger and stats::density</span></span>
<span></span>
<span><span class="va">learned_ranger_homoskedastic_density</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">lnr_ranger_homoskedastic_density</span><span class="op">(</span><span class="va">data</span>, <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_ranger_homoskedastic_density</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Using ranger::ranger for conditional mean and stats::density for error"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-4.png" width="2400"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># glm and stats::density</span></span>
<span></span>
<span><span class="va">learned_glm_homoskedastic_density</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/lnr_homoskedastic_density.html">lnr_homoskedastic_density</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span>, mean_lnr <span class="op">=</span> <span class="va">lnr_glm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_glm_homoskedastic_density</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Using stats::glm for conditional mean and stats::density for error"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-5.png" width="2400"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#  heteroskedastic method </span></span>
<span></span>
<span><span class="va">learned_earth_heteroskedastic_density</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/lnr_heteroskedastic_density.html">lnr_heteroskedastic_density</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>                              <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span>,</span>
<span>                              mean_lnr <span class="op">=</span> <span class="va">lnr_earth</span>,</span>
<span>                              var_lnr <span class="op">=</span> <span class="va">lnr_glm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_earth_heteroskedastic_density</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Using earth::earth for conditional mean, stats::density for error distribution, \nand a stats::glm for predicting heteroskedasticity"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-6.png" width="2400"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># super learner</span></span>
<span></span>
<span><span class="va">learned_sl_density</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>    <span class="va">flipper_length_mm</span> <span class="op">~</span> <span class="va">bill_depth_mm</span>,</span>
<span>    learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      lm <span class="op">=</span> <span class="va">lnr_lm_density</span>,</span>
<span>      earth <span class="op">=</span> <span class="va">lnr_earth_homoskedastic_density</span>,</span>
<span>      rf <span class="op">=</span> <span class="va">lnr_rf_homoskedastic_density</span>,</span>
<span>      ranger <span class="op">=</span> <span class="va">lnr_ranger_homoskedastic_density</span>,</span>
<span>      heteroskedastic <span class="op">=</span> <span class="va">lnr_heteroskedastic_density</span></span>
<span>      <span class="op">)</span>,</span>
<span>    extra_learner_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      heteroskedastic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean_lnr <span class="op">=</span> <span class="va">lnr_earth</span>, var_lnr <span class="op">=</span> <span class="va">lnr_glm</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>    determine_super_learner_weights <span class="op">=</span> <span class="va">determine_weights_using_neg_log_loss</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in validate_learner_types(learners, outcome_type): Learners 1, 2, 3, 4, 5 with names [lm, earth, rf, ranger, heteroskedastic] do not have attr(., 'sl_lnr_type') == 'continuous'.</span></span>
<span><span class="co">#&gt; See the Creating Learners article on the {nadir} website.</span></span>
<span><span class="co">#&gt; </span></span>
<span></span>
<span><span class="va">prediction_grid</span><span class="op">$</span><span class="va">density_prediction</span> <span class="op">&lt;-</span> <span class="fu">learned_sl_density</span><span class="op">(</span><span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_depth_mm</span>, y <span class="op">=</span> <span class="va">flipper_length_mm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction_grid</span>, </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">density_prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">MetBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MetBrewer/man/scale_fill_met_c.html" class="external-link">scale_fill_met_c</a></span><span class="op">(</span><span class="st">'Hiroshige'</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Using super_learner on all of the above with negative log loss"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Density-Estimation_files/figure-html/unnamed-chunk-6-7.png" width="2400"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://ctesta.com" class="external-link">Christian Testa</a>, <a href="https://nimahejazi.org/" class="external-link">Nima Hejazi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
