<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Doubly Robust Estimation ‚Ä¢ nadir</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.0/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Doubly Robust Estimation">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nadir</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Basic-Examples.html">Basic Examples</a></li>
    <li><a class="dropdown-item" href="../articles/Benchmarking.html">Benchmarking Against `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Binary-and-Multiclass-Outcomes.html">Binary and Multiclass Outcomes</a></li>
    <li><a class="dropdown-item" href="../articles/Clustered-Data.html">Clustered and Dependent Data</a></li>
    <li><a class="dropdown-item" href="../articles/comparison_to_SuperLearner.html">Comparison to `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Creating-Learners.html">Creating Learners</a></li>
    <li><a class="dropdown-item" href="../articles/currying_closures_and_function_factories.html">Currying, Closures, and Function Factories</a></li>
    <li><a class="dropdown-item" href="../articles/Density-Estimation.html">Density Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Doubly-Robust-Estimation.html">Doubly Robust Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Error-Handling.html">Error Handling</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/Guidance-for-Developers.html">Guidance for Developers</a></li>
    <li><a class="dropdown-item" href="../articles/Running-super_learner-in-Parallel.html">Running `super_learner()` in Parallel</a></li>
    <li><a class="dropdown-item" href="../articles/Survival.html">Survival Analysis via Pooled Logistic Regression</a></li>
    <li><a class="dropdown-item" href="../articles/Using-Weights.html">Using Observation Weights</a></li>
    <li><a class="dropdown-item" href="../articles/Visualizing-Performance.html">Visualizing Performance</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ctesta01/nadir/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Doubly Robust Estimation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ctesta01/nadir/blob/HEAD/vignettes/articles/Doubly-Robust-Estimation.Rmd" class="external-link"><code>vignettes/articles/Doubly-Robust-Estimation.Rmd</code></a></small>
      <div class="d-none name"><code>Doubly-Robust-Estimation.Rmd</code></div>
    </div>

    
    
<p>One of the central tasks of causal inference is the estimation of
average treatment effects. There are many approaches to doing this, but
one of particular importance is that of <em>doubly robust
estimation</em>.</p>
<p>The following article provides example code for how to create a
doubly robust estimator of an average treatment effect (ATE) using
<code><a href="../reference/super_learner.html">nadir::super_learner()</a></code>.</p>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>For some useful references on doubly robust estimation, we refer the
curious reader to:</p>
<ul>
<li><small> Kang, J. D. Y., &amp; Schafer, J. L. (2007). Demystifying
Double Robustness: A Comparison of Alternative Strategies for Estimating
a Population Mean from Incomplete Data. Statistical Science, 22(4). <a href="https://doi.org/10.1214/07-sts227" class="external-link uri">https://doi.org/10.1214/07-sts227</a> </small></li>
<li><small> Fine Point 13.2 and Technical Point 13.2 of Hern√°n MA,
Robins JM (2020). <em>Causal Inference: What If.</em> Boca Raton:
Chapman &amp; Hall/CRC <a href="https://miguelhernan.org/whatifbook" class="external-link uri">https://miguelhernan.org/whatifbook</a></small></li>
<li><small> Funk, M. J., Westreich, D., Wiesen, C., St√ºrmer, T.,
Brookhart, M. A., &amp; Davidian, M. (2011). Doubly Robust Estimation of
Causal Effects. American Journal of Epidemiology, 173(7), 761‚Äì767. <a href="https://doi.org/10.1093/aje/kwq439" class="external-link uri">https://doi.org/10.1093/aje/kwq439</a></small></li>
<li><small> Bang, H., &amp; Robins, J. M. (2005). Doubly Robust
Estimation in Missing Data and Causal Inference Models. Biometrics,
61(4), 962‚Äì973. <a href="https://doi.org/10.1111/j.1541-0420.2005.00377.x" class="external-link uri">https://doi.org/10.1111/j.1541-0420.2005.00377.x</a></small></li>
<li><small> Zivich, P. N., &amp; Breskin, A. (2021). Machine Learning
for Causal Inference: On the Use of Cross-fit Estimators. Epidemiology,
32(3), 393‚Äì401. <a href="https://doi.org/10.1097/ede.0000000000001332" class="external-link uri">https://doi.org/10.1097/ede.0000000000001332</a></small></li>
</ul>
<p>For a very informal, but introductory explanation, the StitchFix tech
blog <em>Multithreaded</em> has a very nice article here:</p>
<ul>
<li><small> Nettiksimmons, J. &amp; Davies, M. (2021). <em>Gimme a
robust estimator - and make it a double!</em> <a href="https://multithreaded.stitchfix.com/blog/2021/07/23/double-robust-estimator/" class="external-link uri">https://multithreaded.stitchfix.com/blog/2021/07/23/double-robust-estimator/</a>
</small></li>
</ul>
<p>In particular, the following paragraph from Zivich and Breskin nicely
summarizes why it is important to use a doubly robust estimator if using
machine learning algorithms and/or cross-fit estimators like those from
<code><a href="../reference/super_learner.html">nadir::super_learner()</a></code>:</p>
<blockquote>
<small> The need for doubly-robust estimators with cross-fitting when
using data-adaptive machine learning for nuisance function estimation
arises from two terms in the Von Mises expansion of the estimator. The
first term, which is described by an empirical process term in the
expansion, can be controlled by either restricting the complexity of the
nuisance models (e.g., by requiring them to be in the Donsker class) or
through cross-fitting. Because it can be difficult or impossible to
verify that a given machine learning method is in the Donsker class,
cross-fitting provides a simple and attractive alternative. The second
term is the second-order remainder, and it converges to zero as the
sample size increases. For valid inference, it is desirable for this
remainder term to converge as a function of n‚àí1/2, referred to as as
root-n convergence. Convergence rates are not a computational issue, but
rather a feature of the estimator itself. Unfortunately, data-adaptive
algorithms often have slower convergence rates as a result of their
flexibility. However, because the second-order remainder term of
doubly-robust estimators is the product of the approximation errors of
the treatment and outcome nuisance models, doubly-robust estimators only
require that the product of the convergence rates for nuisance models be
n‚àí1/2. To summarize, cross-fitting permits the use of highly complex
nuisance models, while doubly-robust estimators permit the use of slowly
converging nuisance models. Used together, these approaches allow one to
use a wide class of data-adaptive machine learning methods to estimate
causal effects. </small>
</blockquote>
</div>
<div class="section level2">
<h2 id="constructing-an-example-dataset">Constructing an Example Dataset<a class="anchor" aria-label="anchor" href="#constructing-an-example-dataset"></a>
</h2>
<p>We will create a synthetic dataset in which we model the effect of an
active drug (treatment) vs.¬†placebo (control) on a generic health
outcome. Additionally, in our simulated data, the treatment assignment
mechanism to the drug arm will not be completely random, but rather
dependent on some observed covariates (for example, age and income).
This could reflect either an observational setting where participants
self-selected into the treatment arms, or a randomized setting, but
where the assignment into arms was designed by investigators to
(stochastically) rely on age and income.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ctesta01.github.io/nadir/">nadir</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_size</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># sample size for the simulation dataset</span></span>
<span></span>
<span><span class="co"># the simulation dataset has the following properties: </span></span>
<span><span class="co">#   the A-&gt;Y is confounded by the L-&gt;A and L-&gt;Y pathways; </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Y_observed is the "coarsened" or observed one of the two </span></span>
<span><span class="co">#   potential outcomes Y(0) and Y(1). </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Y(0) and Y(1) are constructed as the output of a baseline </span></span>
<span><span class="co">#   mean model given L1 and L2 (mu) and a heterogeneous treatment</span></span>
<span><span class="co">#   effect (tau), again given L1 and L2 </span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    <span class="co"># ages are taken to be between 30 and 50 </span></span>
<span>    L1_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">50</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">sample_size</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co"># household income is centered around $35,000, with a floor of $5,000 </span></span>
<span>    L2_income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">sample_size</span>, meanlog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">30000</span><span class="op">)</span>, sdlog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5000</span>,</span>
<span>    </span>
<span>    <span class="co"># Treatment mechanism: logit depends on age and (log) income</span></span>
<span>    A_treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="va">sample_size</span>,</span>
<span>      size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span> <span class="op">+</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="op">(</span><span class="va">L1_age</span> <span class="op">-</span> <span class="fl">40</span><span class="op">)</span> <span class="op">+</span> <span class="fl">4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L2_income</span> <span class="op">/</span> <span class="fl">40000</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Outcome model components: baseline mu(L) and heterogeneous effect tau(L)</span></span>
<span>    mu  <span class="op">=</span> <span class="fl">50</span> <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> <span class="op">(</span><span class="va">L1_age</span> <span class="op">-</span> <span class="fl">40</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L2_income</span> <span class="op">/</span> <span class="fl">40000</span><span class="op">)</span>,</span>
<span>    tau <span class="op">=</span>  <span class="fl">4</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">*</span> <span class="op">(</span><span class="fl">50</span> <span class="op">-</span> <span class="va">L1_age</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1.2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">L2_income</span> <span class="op">/</span> <span class="fl">40000</span><span class="op">)</span>,</span>
<span>  </span>
<span>    <span class="co"># Potential outcomes and observed outcome</span></span>
<span>    `Y(0)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample_size</span>, mean <span class="op">=</span> <span class="va">mu</span>,          sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    `Y(1)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample_size</span>, mean <span class="op">=</span> <span class="va">mu</span> <span class="op">+</span> <span class="va">tau</span>,    sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    Y_observed <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">A_treatment</span> <span class="op">==</span> <span class="fl">1L</span>, <span class="va">`Y(1)`</span>, <span class="va">`Y(0)`</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">mu</span>, <span class="op">-</span><span class="va">tau</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualizing-confounding-in-the-dataset">Visualizing Confounding in the Dataset<a class="anchor" aria-label="anchor" href="#visualizing-confounding-in-the-dataset"></a>
</h2>
<p>Below we visualize how the treatment-assignment and treatment effect
on the outcome are confounded by the age and income covariates.</p>
<p>Intuitively, the way to understand the problem this confounding poses
to estimating an average treatment effect is as follows:</p>
<ul>
<li>Under a completely randomized regime, we‚Äôd like to be able to simply
compare the treated to the placebo arm in their outcomes.</li>
<li>However, the people in the treated arm are systematically different
(in a distributional sense) from the people in the placebo arm. They are
higher in income and age, on average.</li>
<li>As a result, any good estimator for the average treatment effect
should take this systematic difference into account.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">default_theme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">L1_age</span>, y <span class="op">=</span> <span class="va">A_treatment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">0.025</span>, width <span class="op">=</span> <span class="fl">0.25</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">stat_smooth</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="st">"y ~ x"</span>, method <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>                method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="va">default_theme</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">%-&gt;%</span> <span class="va">Treatment</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">L2_income</span>, y <span class="op">=</span> <span class="va">A_treatment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">0.025</span>, width <span class="op">=</span> <span class="fl">0.25</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">stat_smooth</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="st">"y ~ x"</span>, method <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>                method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family<span class="op">=</span><span class="st">"binomial"</span><span class="op">)</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="va">default_theme</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html" class="external-link">dollar_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">Income</span> <span class="op">%-&gt;%</span> <span class="va">Treatment</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">L1_age</span>, y <span class="op">=</span> <span class="va">Y_observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.25</span>, height <span class="op">=</span> <span class="fl">0.025</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="va">default_theme</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">%-&gt;%</span> <span class="va">Outcome</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">L2_income</span>, y <span class="op">=</span> <span class="va">Y_observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="va">default_theme</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html" class="external-link">dollar_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">Income</span> <span class="op">%-&gt;%</span> <span class="va">Outcome</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">patchwork</span> <span class="op">&lt;-</span> <span class="op">{</span> <span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span> <span class="op">}</span> <span class="op">/</span> <span class="op">{</span> <span class="va">p3</span> <span class="op">|</span> <span class="va">p4</span> <span class="op">}</span> </span>
<span></span>
<span><span class="va">patchwork</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span></span>
<span>  title <span class="op">=</span> <span class="st">"Evidence of Confounding"</span>,</span>
<span>  subtitle <span class="op">=</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>      <span class="st">"The following four relationships are visualized: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">L</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">L</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">%-&gt;%</span> <span class="va">A</span>, <span class="va">L</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">L</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">%-&gt;%</span> <span class="va">Y</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span>, </span>
<span>  theme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula = 'y ~ x'</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula = 'y ~ x'</span></span></code></pre></div>
<p><img src="Doubly-Robust-Estimation_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="determine-the-true-average-treatment-effect">Determine the True Average Treatment Effect<a class="anchor" aria-label="anchor" href="#determine-the-true-average-treatment-effect"></a>
</h2>
<p>Since the data are simulated including both poptential outcomes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(1)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(0)</annotation></semantics></math>,
we are able to obtain the average treatment effect for this population
as a simple average of the individual treatment effects. Normally, this
is not possible in the real world, because we cannot assign both
treatment and placebo to the same individuals in order to observe both
potential outcomes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the true average treatment effect</span></span>
<span><span class="va">true_ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">`Y(1)`</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">`Y(0)`</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"True ATE: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">true_ate</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "True ATE: 4.43"</span></span>
<span></span>
<span><span class="co"># visualize the individual treatment effects</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">`Y(1)`</span> <span class="op">-</span> <span class="va">`Y(0)`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'cadetblue'</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">true_ate</span>, color <span class="op">=</span> <span class="st">'firebrick'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">default_theme</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Individual Treatment Effect"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span></span>
<span>    <span class="st">"Histogram of the Individual Treatment Effects"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"We can only know these because this is a simulation.  The ATE is shown by the red vertical line."</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="Doubly-Robust-Estimation_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>So this number, 4.43, is what we‚Äôre looking to estimate with our
doubly robust code below, and without knowledge of <code>Y(1)</code> and
<code>Y(0)</code> but instead only of <code>Y_observed</code>.</p>
</div>
<div class="section level2">
<h2 id="fitting-the-outcome-and-propensity-score-models">Fitting the Outcome and Propensity Score Models<a class="anchor" aria-label="anchor" href="#fitting-the-outcome-and-propensity-score-models"></a>
</h2>
<p>As a reminder, the outcome model refers to the model of the outcome
given the treatment received and covariates, while the propensity score
refers to the probability of receiving treatment given the
covariates.</p>
<p>In mathematical notation, we denote these as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>A</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚â°</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>Y</mi><mo>‚à£</mo><mi>A</mi><mo>,</mo><mi>L</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
m_A(L) \equiv \mathbb{E}\left[ Y \mid A, L\right], 
</annotation></semantics></math> and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>œÄ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚â°</mo><mi>‚Ñô</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mn>1</mn><mo>‚à£</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\pi(L) \equiv \mathbb{P}(A = 1 \mid L).
</annotation></semantics></math></p>
<p>The above refer to the true outcome model and propensity score
models, but when we estimate them from the data using an algorithm, we
refer to the estimated models as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>m</mi><mo accent="true">ÃÇ</mo></mover><mi>A</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{m}_A(L)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{\pi}(L)</annotation></semantics></math>.</p>
<p>Note that in the real world, we don‚Äôt get to see both
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(1)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(0)</annotation></semantics></math>
‚Äì we only get to see the observed outcome, which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>A</mi><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>A</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y = A Y(1) + (1-A) Y(0)</annotation></semantics></math>.
As such, we‚Äôll drop the values <code>Y(1)</code> and <code>Y(0)</code>
from the dataset so we don‚Äôt risk accidentally making any use of them in
our estimation procedure.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">`Y(1)`</span>, <span class="va">`Y(0)`</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we‚Äôre ready to fit outcome and propensity score models to the
data. To be as flexible as possible, we will use
<code><a href="../reference/super_learner.html">nadir::super_learner()</a></code> with a variety of different
learners.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcome_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, </span>
<span>  formulas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .default <span class="op">=</span> <span class="va">Y_observed</span> <span class="op">~</span> <span class="va">L1_age</span> <span class="op">+</span> <span class="va">L2_income</span> <span class="op">+</span> <span class="va">A_treatment</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">Y_observed</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">L1_age</span>, <span class="va">L2_income</span><span class="op">)</span> <span class="op">+</span> <span class="va">A_treatment</span><span class="op">)</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="va">lnr_mean</span>,</span>
<span>    lm <span class="op">=</span> <span class="va">lnr_lm</span>,</span>
<span>    earth <span class="op">=</span> <span class="va">lnr_earth</span>,</span>
<span>    rf <span class="op">=</span> <span class="va">lnr_rf</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">lnr_gam</span>,</span>
<span>    hal <span class="op">=</span> <span class="va">lnr_hal</span></span>
<span>    <span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">propensity_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, </span>
<span>  formulas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    .default <span class="op">=</span> <span class="va">A_treatment</span> <span class="op">~</span> <span class="va">L1_age</span> <span class="op">+</span> <span class="va">L2_income</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">A_treatment</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">L1_age</span>, <span class="va">L2_income</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="va">lnr_mean</span>,</span>
<span>    logistic <span class="op">=</span> <span class="va">lnr_logistic</span>,</span>
<span>    rf <span class="op">=</span> <span class="va">lnr_rf_binary</span>,</span>
<span>    earth <span class="op">=</span> <span class="va">lnr_earth</span>,</span>
<span>    xgboost <span class="op">=</span> <span class="va">lnr_xgboost</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">lnr_gam</span>,</span>
<span>    hal <span class="op">=</span> <span class="va">lnr_hal</span><span class="op">)</span>,</span>
<span>  extra_learner_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    earth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>glm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family<span class="op">=</span><span class="st">'binomial'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    xgboost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>objective <span class="op">=</span> <span class="st">'binary:logistic'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    gam <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span>,</span>
<span>    hal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">'binomial'</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  outcome_type <span class="op">=</span> <span class="st">'binary'</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>There are details about the fit available when using the
<code>verbose = TRUE</code> option that allow us to see which learners
were favored, and how they performed:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># learner weights </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">outcome_model</span><span class="op">$</span><span class="va">learner_weights</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;  mean    lm earth    rf   gam   hal </span></span>
<span><span class="co">#&gt;  0.00  0.00  0.11  0.05  0.66  0.18</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">propensity_model</span><span class="op">$</span><span class="va">learner_weights</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;     mean logistic       rf    earth  xgboost      gam      hal </span></span>
<span><span class="co">#&gt;     0.00     0.00     0.22     0.00     0.00     0.58     0.21</span></span>
<span></span>
<span><span class="co"># compare learners by their loss metric</span></span>
<span><span class="fu"><a href="../reference/compare_learners.html">compare_learners</a></span><span class="op">(</span><span class="va">outcome_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inferring the loss metric for learner comparison based on the outcome type:</span></span>
<span><span class="co">#&gt; outcome_type=continuous -&gt; using mean squared error</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 √ó 6</span></span></span>
<span><span class="co">#&gt;    mean    lm earth    rf   gam   hal</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  8.01  3.67  1.20  1.83  1.15  1.44</span></span>
<span><span class="fu"><a href="../reference/compare_learners.html">compare_learners</a></span><span class="op">(</span><span class="va">propensity_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inferring the loss metric for learner comparison based on the outcome type:</span></span>
<span><span class="co">#&gt; outcome_type=binary -&gt; using negative log loss</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 √ó 7</span></span></span>
<span><span class="co">#&gt;    mean logistic    rf earth xgboost   gam   hal</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  194.     84.2  85.6  95.0    148.  75.3  81.4</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="doubly-robust-estimation-and-inference">Doubly Robust Estimation and Inference<a class="anchor" aria-label="anchor" href="#doubly-robust-estimation-and-inference"></a>
</h2>
<p>Now that we‚Äôve fit our outcome model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>m</mi><mo accent="true">ÃÇ</mo></mover><mi>A</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{m}_A(L)</annotation></semantics></math>
and our propensity score model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{\pi}(L)</annotation></semantics></math>,
we can proceed with constructing a doubly robust estimate of the average
treatment effect.</p>
<p>There are several different doubly robust estimators of the ATE, but
here we will use the one-step estimator. The one-step estimator of the
ATE has the following form: <!--
$$
\hat \theta_{\text{DR}} = \frac{1}{n} \sum_{i=1}^n \left\{ 
\left( \hat m_1(L_i) + \frac{A_i}{\hat \pi(L_i)} (Y_i - \hat m_1(L_i))\right) - 
\left( \hat m_0(L_i) + \frac{1-A_i}{1-\hat \pi(L_i)}(Y_i - \hat m_0(L_i)) \right)
\right\}.
$$
-->
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>‚àë</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mo stretchy="true" form="prefix">{</mo><msub><mover><mi>m</mi><mo accent="true">ÃÇ</mo></mover><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><msub><mover><mi>m</mi><mo accent="true">ÃÇ</mo></mover><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mrow><mn>1</mn><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>‚àí</mo><mfrac><mrow><mn>1</mn><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>1</mn><mo>‚àí</mo><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo>‚àí</mo><msub><mover><mi>m</mi><mo accent="true">ÃÇ</mo></mover><msub><mi>A</mi><mi>i</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">}</mo></mrow></mrow><annotation encoding="application/x-tex"> 
\hat \theta = \frac{1}{n} \sum_{i=1}^n \left\{ 
\hat m_1(L_i) - \hat m_0(L_i) + \left[ \frac{1(A_i = 1)}{\hat \pi(L_i)} - \frac{1(A=0)}{1 - \hat \pi(L_i)} \right] \left( Y_i - \hat m_{A_i}(L_i) \right)
\right\}
</annotation></semantics></math></p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><annotation encoding="application/x-tex">\hat{\theta}</annotation></semantics></math>
is an asymptotically linear estimator, meaning it admits the following
asymptotic representation as a linear sum plus a term decaying to 0 in
probability:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>n</mi></msqrt><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mo>‚àí</mo><msub><mi>Œ∏</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><msqrt><mi>n</mi></msqrt></mfrac><munderover><mo>‚àë</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>o</mi><mi>‚Ñô</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\sqrt{n}(\hat \theta - \theta_0) = \frac{1}{\sqrt{n}} \sum_{i=1}^n D(O_i) + o_{\mathbb P}(1).
</annotation></semantics></math> In the above equation,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ∏</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\theta_0</annotation></semantics></math>
is the true ATE,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">D(O_i)</annotation></semantics></math>
is the efficient influence function, and is
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><msub><mi>m</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><msub><mi>m</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mrow><mn>1</mn><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>œÄ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>‚àí</mo><mfrac><mrow><mn>1</mn><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>1</mn><mo>‚àí</mo><mi>œÄ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo>‚àí</mo><msub><mi>m</mi><msub><mi>A</mi><mi>i</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">}</mo></mrow><mo>‚àí</mo><msub><mi>Œ∏</mi><mn>0</mn></msub><mi>.</mi></mrow><annotation encoding="application/x-tex">
D(O_i) = \left\{ 
 m_1(L_i) -  m_0(L_i) + \left[ \frac{1(A_i = 1)}{\pi(L_i)} - \frac{1(A=0)}{1 - \pi(L_i)} \right] \left( Y_i - m_{A_i}(L_i) \right)
\right\} - \theta_0.
</annotation></semantics></math></p>
<p>Because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><annotation encoding="application/x-tex">\hat \theta</annotation></semantics></math>
is asymptotically linear, we can use the efficient influence function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">D(O_i)</annotation></semantics></math>
to construct asymptotically valid confidence intervals. More
specifically, the following asymptotic result allows us to estimate
valid asymptotic confidence intervals.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>n</mi></msqrt><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mo>‚àí</mo><msub><mi>Œ∏</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mover><mo>‚Üí</mo><mi>d</mi></mover><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mfrac><mrow><mtext mathvariant="normal">Var</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>D</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mi>n</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\sqrt{n}(\hat \theta - \theta_0) \xrightarrow{d} \mathcal N\left(0, \frac{\text{Var}(D)}{n}\right).
</annotation></semantics></math></p>
<p>Some useful references on efficient influence function based
inference are</p>
<ul>
<li><small>Hines, O., Dukes, O., Diaz-Ordaz, K., &amp; Vansteelandt, S.
(2022). Demystifying Statistical Learning Based on Efficient Influence
Functions. The American Statistician, 76(3), 292‚Äì304. <a href="https://doi.org/10.1080/00031305.2021.2021984" class="external-link uri">https://doi.org/10.1080/00031305.2021.2021984</a>
</small></li>
<li><small> Kennedy, E. H. (2022). Semiparametric doubly robust targeted
double machine learning: a review (Version 2). arXiv. <a href="https://doi.org/10.48550/ARXIV.2203.06469" class="external-link uri">https://doi.org/10.48550/ARXIV.2203.06469</a> </small></li>
<li><small> Fisher, A., &amp; Kennedy, E. H. (2020). Visually
Communicating and Teaching Intuition for Influence Functions. The
American Statistician, 75(2), 162‚Äì172. <a href="https://doi.org/10.1080/00031305.2020.1717620" class="external-link uri">https://doi.org/10.1080/00031305.2020.1717620</a>
</small></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">A_treatment</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">Y_observed</span> </span>
<span></span>
<span><span class="co"># get components of propensity scores</span></span>
<span><span class="va">pi_hat_of_L</span> <span class="op">&lt;-</span> <span class="va">propensity_model</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="va">one_minus_pi_hat_of_L</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="va">pi_hat_of_L</span></span>
<span></span>
<span><span class="co"># get outcome predictions</span></span>
<span><span class="va">m_of_0_exposure_and_L</span> <span class="op">&lt;-</span> <span class="co"># counterfactual model, everyone untreated</span></span>
<span>  <span class="va">outcome_model</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="op">{</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>A_treatment <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_of_1_exposure_and_L</span> <span class="op">&lt;-</span> <span class="co"># counterfactual model, everyone treated</span></span>
<span>  <span class="va">outcome_model</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="op">{</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>A_treatment <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_of_A_and_L</span> <span class="op">&lt;-</span> <span class="va">outcome_model</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="co"># outcome model for treatment received</span></span>
<span></span>
<span><span class="co"># these are the components of the uncentered EIF</span></span>
<span><span class="va">uncentered_EIF</span> <span class="op">&lt;-</span> <span class="va">m_of_1_exposure_and_L</span> <span class="op">-</span> <span class="va">m_of_0_exposure_and_L</span> <span class="op">+</span> </span>
<span>  <span class="op">(</span><span class="va">A</span><span class="op">/</span><span class="va">pi_hat_of_L</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">A</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span> <span class="va">pi_hat_of_L</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">Y</span> <span class="op">-</span> <span class="va">m_of_A_and_L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we use the uncentered EIF to estimate theta_hat</span></span>
<span><span class="co"># this can be thought of as solving the estimating equation </span></span>
<span><span class="co">#    uncentered_EIF - theta_0 = 0</span></span>
<span><span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">uncentered_EIF</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># center the efficient influence function</span></span>
<span><span class="va">EIF</span> <span class="op">&lt;-</span> <span class="va">uncentered_EIF</span> <span class="op">-</span> <span class="va">theta_hat</span></span>
<span></span>
<span><span class="co"># in order to conduct inference, we can use the influence curve of the </span></span>
<span><span class="co"># estimator and take its variance divided by n</span></span>
<span><span class="va">theta_hat_variance_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">EIF</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate confidence intervals</span></span>
<span><span class="va">ATE_ConfidenceIntervals</span> <span class="op">&lt;-</span> <span class="va">theta_hat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">theta_hat_variance_estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format the results</span></span>
<span><span class="va">formatted_CI</span> <span class="op">&lt;-</span></span>
<span>  <span class="co"># sprintf(fmt = "%.2f", ...) formats a numeric to a string that has two digits</span></span>
<span>  <span class="co"># past the decimal, even if there are trailing zeroes. round(0.4, 2) evaluates</span></span>
<span>  <span class="co"># to "0.4", while sprintf(fmt = "%.2f", 0.4) evaluates to "0.40".</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span>fmt <span class="op">=</span> <span class="st">"%.2f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span></span>
<span>    <span class="va">ATE_ConfidenceIntervals</span>, <span class="fl">2</span></span>
<span>  <span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">', '</span><span class="op">)</span>,</span>
<span>  <span class="st">")"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># print the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"ATE Estimate: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span>fmt <span class="op">=</span> <span class="st">"%.2f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">theta_hat</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span>,</span>
<span>  <span class="st">"Confidence Intervals: "</span>, <span class="va">formatted_CI</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ATE Estimate: 4.48</span></span>
<span><span class="co">#&gt; Confidence Intervals: (4.33, 4.63)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>It looks like our estimate 4.48 is quite close to the true value,
4.43, which is great! Moreover, the truth easily lies within the
confidence interval produced (4.33, 4.63).</p>
<p>What is truly remarkable about this approach, as you can read about
in the references listed throughout this article, is that by
cross-fitting our nuisance models (as in, via
<code><a href="../reference/super_learner.html">nadir::super_learner()</a></code>) and using a doubly robust
estimator, we are able to avoid problems related to the curse of
dimensionality in machine learning algorithms (i.e., what is often
called regularization bias or overfitting bias) and are able to produce
consistent estimates of causal parameters with asymptotically valid
confidence intervals under relatively mild assumptions.</p>
<p>If you want to keep going with <code><a href="../reference/super_learner.html">nadir::super_learner()</a></code>
for causal inference, natural subsequent directions are to use it with
other causal parameters besides the ATE, like the average treatment
effect among the treated, instrumental variables estimands, mediational
quantities like direct/indirect effects, heterogeneous treatment
effects, or continuous treatment effects like modified treatment policy
effects, and more.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://ctesta.com" class="external-link">Christian Testa</a>, <a href="https://nimahejazi.org/" class="external-link">Nima Hejazi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
