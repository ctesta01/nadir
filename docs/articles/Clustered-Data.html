<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Clustered and Dependent Data • nadir</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.0/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Clustered and Dependent Data">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nadir</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Basic-Examples.html">Basic Examples</a></li>
    <li><a class="dropdown-item" href="../articles/Benchmarking.html">Benchmarking Against `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Binary-and-Multiclass-Outcomes.html">Binary and Multiclass Outcomes</a></li>
    <li><a class="dropdown-item" href="../articles/Clustered-Data.html">Clustered and Dependent Data</a></li>
    <li><a class="dropdown-item" href="../articles/comparison_to_SuperLearner.html">Comparison to `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Creating-Learners.html">Creating Learners</a></li>
    <li><a class="dropdown-item" href="../articles/currying_closures_and_function_factories.html">Currying, Closures, and Function Factories</a></li>
    <li><a class="dropdown-item" href="../articles/Density-Estimation.html">Density Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Doubly-Robust-Estimation.html">Doubly Robust Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Error-Handling.html">Error Handling</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/Guidance-for-Developers.html">Guidance for Developers</a></li>
    <li><a class="dropdown-item" href="../articles/Running-super_learner-in-Parallel.html">Running `super_learner()` in Parallel</a></li>
    <li><a class="dropdown-item" href="../articles/Visualizing-Performance.html">Visualizing Performance</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ctesta01/nadir/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Clustered and Dependent Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ctesta01/nadir/blob/HEAD/vignettes/articles/Clustered-Data.Rmd" class="external-link"><code>vignettes/articles/Clustered-Data.Rmd</code></a></small>
      <div class="d-none name"><code>Clustered-Data.Rmd</code></div>
    </div>

    
    
<p>The assumptions present in using cross validation to estimate the
risk on unseen data as is done in the super learner algorithm include
that the training and validation splits are independent samples from the
underlying data distribution.</p>
<p>If the data come from clusters or otherwise dependent samples, we
need to make sure that the cross-validation do not split up clusters by
putting some observations into training splits and others into a
validation split from the same cluster.</p>
<p>Read about this in <em>Practical considerations for specifying a
super learner</em> by Rachel Phillips et al (2023, Int J Epidemiology)
<a href="https://academic.oup.com/ije/article/52/4/1276/7076266" class="external-link uri">https://academic.oup.com/ije/article/52/4/1276/7076266</a>.</p>
<blockquote>
<p>When the data are not i.i.d., clustered observations must be assigned
as a group to the same validation and training sets. This ensures the
validation data are completely independent of the training data, and the
loss function is evaluated at the cluster level. V-fold CV with
clustered data is specified with existing SL software by supplying a
cluster identifier to the ‘id’ argument.</p>
</blockquote>
<p>The above quote is describing the syntax of the
<a href="https://github.com/ecpolley/SuperLearner" class="external-link">SuperLearner</a> package, so we try to achieve something
similar. We just need to specify a schema using <a href="https://tlverse.org/origami/" class="external-link">origami</a>
as follows.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ctesta01.github.io/nadir/">nadir</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/origami/" class="external-link">origami</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## origami v1.0.7: Generalized Framework for Cross-Validation</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate synthetic clustered data </span></span>
<span><span class="va">n_clusters</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span><span class="va">n_participants</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">cluster_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">100</span>, <span class="va">n_participants</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">drug</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n_participants</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cluster_mean_outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">25</span>, sd <span class="op">=</span> <span class="fl">5</span>, n <span class="op">=</span> <span class="va">n_clusters</span><span class="op">)</span></span>
<span></span>
<span><span class="va">participant_outcomes</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">cluster_mean_outcomes</span><span class="op">[</span><span class="va">cluster_ids</span><span class="op">]</span> <span class="op">+</span> </span>
<span>  <span class="va">drug</span> <span class="op">*</span> <span class="fl">15</span> <span class="op">+</span> </span>
<span>  <span class="va">age</span> </span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  cluster_id <span class="op">=</span> <span class="va">cluster_ids</span>,</span>
<span>  age <span class="op">=</span> <span class="va">age</span>, </span>
<span>  drug <span class="op">=</span> <span class="va">drug</span>, </span>
<span>  outcome <span class="op">=</span> <span class="va">participant_outcomes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">sl_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>,</span>
<span>  formulas <span class="op">=</span> <span class="va">outcome</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">drug</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lnr_rf</span>, <span class="va">lnr_lm</span>, <span class="va">lnr_earth</span>, <span class="va">lnr_glmnet</span><span class="op">)</span>,</span>
<span>  cluster_ids <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">cluster_id</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Behind the scenes, if <code>cluster_ids</code> or
<code>strata_ids</code> are passed to <code><a href="../reference/super_learner.html">super_learner()</a></code>, the
<code>cv_schema</code> argument is being set to</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_schema</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">n_folds</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/cv_origami_schema.html">cv_origami_schema</a></span><span class="op">(</span><span class="va">data</span>, n_folds <span class="op">=</span> <span class="va">n_folds</span>, </span>
<span>    fold_fun <span class="op">=</span> <span class="fu">origami</span><span class="fu">::</span><span class="va">folds_vfun</span>, </span>
<span>    cluster_ids <span class="op">=</span> <span class="va">cluster_ids</span>,</span>
<span>    strata_ids <span class="op">=</span> <span class="va">strata_ids</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s check see explicitly how <code>cv_origami_schema</code> is
working:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_splits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv_origami_schema.html">cv_origami_schema</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>,n_folds <span class="op">=</span> <span class="fl">5</span>, fold_fun <span class="op">=</span> <span class="fu">origami</span><span class="fu">::</span><span class="va"><a href="http://tlverse.org/origami/reference/fold_funs.html" class="external-link">folds_vfold</a></span>, cluster_ids <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">cluster_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">unisort</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">unisort</span><span class="op">(</span><span class="va">df_splits</span><span class="op">$</span><span class="va">training_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cluster_id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  2  3  4  5  7  8  9 12 13 14 15 16 17 18 19 20 21 23 24 25</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unisort</span><span class="op">(</span><span class="va">df_splits</span><span class="op">$</span><span class="va">validation_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cluster_id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  1  6 10 11 22</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unisort</span><span class="op">(</span><span class="va">df_splits</span><span class="op">$</span><span class="va">training_data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cluster_id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  4  5  6  7  8  9 10 11 14 15 16 17 20 21 22 23 24 25</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unisort</span><span class="op">(</span><span class="va">df_splits</span><span class="op">$</span><span class="va">validation_data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cluster_id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  3 12 13 18 19</span></span></code></pre>
<p>So we can see that <code>cv_origami_schema</code> assigns all of each
cluster to either the training or validation data in each split.</p>
<p>In fact, we can get equivalent results if we run the following code,
which shows explicitly how to pass a user-chosen origami
<code>folds_*</code> function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">sl_model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>,</span>
<span>  formulas <span class="op">=</span> <span class="va">outcome</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">drug</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lnr_rf</span>, <span class="va">lnr_lm</span>, <span class="va">lnr_earth</span>, <span class="va">lnr_glmnet</span><span class="op">)</span>,</span>
<span>  cv_schema <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">n_folds</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/cv_origami_schema.html">cv_origami_schema</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, n_folds <span class="op">=</span> <span class="va">n_folds</span>, fold_fun <span class="op">=</span> <span class="fu">origami</span><span class="fu">::</span><span class="va"><a href="http://tlverse.org/origami/reference/fold_funs.html" class="external-link">folds_vfold</a></span>,</span>
<span>                      cluster_ids <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">cluster_id</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sl_model</span><span class="op">$</span><span class="va">learner_weights</span></span></code></pre></div>
<pre><code><span><span class="co">##        rf        lm     earth    glmnet </span></span>
<span><span class="co">## 0.0000000 0.6891014 0.3108986 0.0000000</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sl_model2</span><span class="op">$</span><span class="va">learner_weights</span></span></code></pre></div>
<pre><code><span><span class="co">##        rf        lm     earth    glmnet </span></span>
<span><span class="co">## 0.0000000 0.6891014 0.3108986 0.0000000</span></span></code></pre>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://ctesta.com" class="external-link">Christian Testa</a>, <a href="https://nimahejazi.org/" class="external-link">Nima Hejazi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
