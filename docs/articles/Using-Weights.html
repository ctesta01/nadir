<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using Observation Weights • nadir</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.0/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Observation Weights">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nadir</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Basic-Examples.html">Basic Examples</a></li>
    <li><a class="dropdown-item" href="../articles/Benchmarking.html">Benchmarking Against `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Binary-and-Multiclass-Outcomes.html">Binary and Multiclass Outcomes</a></li>
    <li><a class="dropdown-item" href="../articles/Clustered-Data.html">Clustered and Dependent Data</a></li>
    <li><a class="dropdown-item" href="../articles/comparison_to_SuperLearner.html">Comparison to `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Creating-Learners.html">Creating Learners</a></li>
    <li><a class="dropdown-item" href="../articles/currying_closures_and_function_factories.html">Currying, Closures, and Function Factories</a></li>
    <li><a class="dropdown-item" href="../articles/Density-Estimation.html">Density Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Doubly-Robust-Estimation.html">Doubly Robust Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Error-Handling.html">Error Handling</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/Guidance-for-Developers.html">Guidance for Developers</a></li>
    <li><a class="dropdown-item" href="../articles/Running-super_learner-in-Parallel.html">Running `super_learner()` in Parallel</a></li>
    <li><a class="dropdown-item" href="../articles/Using-Weights.html">Using Observation Weights</a></li>
    <li><a class="dropdown-item" href="../articles/Visualizing-Performance.html">Visualizing Performance</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ctesta01/nadir/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using Observation Weights</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ctesta01/nadir/blob/HEAD/vignettes/articles/Using-Weights.Rmd" class="external-link"><code>vignettes/articles/Using-Weights.Rmd</code></a></small>
      <div class="d-none name"><code>Using-Weights.Rmd</code></div>
    </div>

    
    
<p>There may be non-trivial reasons to weight the observations passed
into <code><a href="../reference/super_learner.html">nadir::super_learner()</a></code>. One such example might be when
the outcome is a population prevalence or incidence rate and the
observations should be <em>weighted</em> to reflect the fact that the
outcomes may represent varying amounts of underlying exposure-time (or
person-time frequently in epidemiology).</p>
<p>We demonstrate here how to use weighted observations in
<code><a href="../reference/super_learner.html">super_learner()</a></code> and check that the loss in a weighted
<code><a href="../reference/super_learner.html">super_learner()</a></code> is favorably reduced on higher weight
observations compared to in an unweighted
<code><a href="../reference/super_learner.html">super_learner()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ctesta01.github.io/nadir/">nadir</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate synthetic data </span></span>
<span><span class="va">n_counties</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  county_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_counties</span>,</span>
<span>  county_person_years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_counties</span>, meanlog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span>,</span>
<span>  <span class="co"># if it's a particularly rural county, we assume the average age is slightly higher</span></span>
<span>  county_mean_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">20</span><span class="op">:</span><span class="fl">60</span>, <span class="va">n_counties</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  county_avg_sbp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">90</span><span class="op">:</span><span class="fl">150</span>, <span class="va">n_counties</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">county_mean_age</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">county_mean_age</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">county_mean_age</span><span class="op">)</span>,</span>
<span>  <span class="co"># counties have between hundreds to hundreds of thousands of people;</span></span>
<span>  <span class="co"># we assume we have observed 1 year of time for all people in the county</span></span>
<span>  county_incidence_rate <span class="op">=</span> </span>
<span>   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">county_person_years</span> <span class="op">&gt;=</span> <span class="fl">1e5</span> <span class="op">&amp;</span> <span class="va">county_person_years</span> <span class="op">&lt;</span> <span class="fl">2e5</span> <span class="op">~</span> </span>
<span>           <span class="fl">50</span> <span class="op">+</span> <span class="fl">1.5</span> <span class="op">*</span> <span class="va">county_mean_age</span> <span class="op">+</span> <span class="fl">1.3</span> <span class="op">*</span> <span class="va">county_mean_age</span><span class="op">^</span><span class="op">{</span><span class="fl">4</span><span class="op">/</span><span class="fl">3</span><span class="op">}</span> <span class="op">+</span> </span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">county_avg_sbp</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_counties</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>      <span class="va">county_person_years</span> <span class="op">&lt;</span> <span class="fl">1e5</span> <span class="op">~</span> </span>
<span>        <span class="fl">25</span> <span class="op">+</span> <span class="fl">1.9</span> <span class="op">*</span> <span class="va">county_mean_age</span> <span class="op">+</span> <span class="fl">1.6</span> <span class="op">*</span> <span class="va">county_mean_age</span><span class="op">^</span><span class="op">{</span><span class="fl">3</span><span class="op">/</span><span class="fl">2</span><span class="op">}</span> <span class="op">+</span> </span>
<span>             <span class="fl">1.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">county_avg_sbp</span><span class="op">)</span>,</span>
<span>      <span class="va">county_person_years</span> <span class="op">&gt;=</span> <span class="fl">2e5</span> <span class="op">~</span> </span>
<span>        <span class="fl">35</span> <span class="op">+</span> <span class="fl">1.7</span> <span class="op">*</span> <span class="va">county_mean_age</span> <span class="op">+</span> <span class="fl">1.6</span> <span class="op">*</span> <span class="va">county_mean_age</span><span class="op">^</span><span class="op">{</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">}</span> <span class="op">+</span> </span>
<span>             <span class="fl">1.4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">county_avg_sbp</span><span class="op">)</span>,</span>
<span>      </span>
<span>    <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_counties</span>, mean <span class="op">=</span> <span class="fl">100</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   county_id county_person_years county_mean_age county_avg_sbp</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>         1                <span style="text-decoration: underline;">2</span>685              30           88.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>         2              <span style="text-decoration: underline;">229</span>867              41          100. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>         3             2<span style="text-decoration: underline;">587</span>630              21          122. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>         4                  98              50          150. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>         5              <span style="text-decoration: underline;">362</span>336              53          100. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>         6              <span style="text-decoration: underline;">456</span>396              43          105. </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: county_incidence_rate &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Let’s take a look at what the simulated data look like. You can see
that depending on whether we focus on the large population counties or
smaller population counties, we should pick up on different trends.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">county_mean_age</span>, y <span class="op">=</span> <span class="va">county_incidence_rate</span>, size <span class="op">=</span> <span class="va">county_person_years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_continuous</a></span><span class="op">(</span></span>
<span>    transform <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/transform_log.html" class="external-link">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">1e5</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">1e5</span>, <span class="fl">1e6</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'100'</span>, <span class="st">'1000'</span>, <span class="st">'100k'</span>, <span class="st">'1m'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="Using-Weights_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">county_mean_age</span>, y <span class="op">=</span> <span class="va">county_incidence_rate</span>, size <span class="op">=</span> <span class="va">county_person_years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">county_person_years</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1e5</span>, <span class="fl">2e5</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span><span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_continuous</a></span><span class="op">(</span>transform <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/transform_log.html" class="external-link">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">1e5</span><span class="op">)</span>,</span>
<span>                        breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">1e5</span>, <span class="fl">1e6</span><span class="op">)</span>,</span>
<span>                        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'100'</span>, <span class="st">'1000'</span>, <span class="st">'100k'</span>, <span class="st">'1m'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Using-Weights_files/figure-html/unnamed-chunk-2-2.png" width="700"></p>
<p>Now let’s fit two super learners, one of which has its
<code>weights</code> set so that each observation is person-time
weighted.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># non-weighted super_learner</span></span>
<span><span class="va">sl_model_no_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, </span>
<span>  formula <span class="op">=</span> <span class="va">county_incidence_rate</span> <span class="op">~</span> <span class="va">county_mean_age</span> <span class="op">+</span> <span class="va">county_avg_sbp</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lnr_lm</span>, <span class="va">lnr_earth</span>, <span class="va">lnr_rf</span>, <span class="va">lnr_xgboost</span>, <span class="va">lnr_glmnet</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sl_model_with_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/super_learner.html">super_learner</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, </span>
<span>  formula <span class="op">=</span> <span class="va">county_incidence_rate</span> <span class="op">~</span> <span class="va">county_mean_age</span> <span class="op">+</span> <span class="va">county_avg_sbp</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lnr_lm</span>, <span class="va">lnr_earth</span>, <span class="va">lnr_rf</span>, <span class="va">lnr_xgboost</span>, <span class="va">lnr_glmnet</span><span class="op">)</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">county_person_years</span>, <span class="co"># ifelse(df$county_person_years &gt; 2e5, 1, 0), </span></span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">squared_errors_with_no_weights</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sl_model_no_weights</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">county_incidence_rate</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">squared_errors_with_weights</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sl_model_with_weights</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">county_incidence_rate</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="co"># let's look at the larger counties</span></span>
<span><span class="va">high_weight_observations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">county_person_years</span> <span class="op">&gt;</span> <span class="fl">2e5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">high_weight_observations</span><span class="op">)</span> <span class="co"># </span></span>
<span><span class="co">#&gt; [1] 205</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">squared_errors_with_no_weights</span><span class="op">[</span><span class="va">high_weight_observations</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 63721.07</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">squared_errors_with_weights</span><span class="op">[</span><span class="va">high_weight_observations</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2408.222</span></span>
<span></span>
<span><span class="co"># we'll generate some newdata to predict on; just at the mean sbp and </span></span>
<span><span class="co"># across the observed range of data.</span></span>
<span><span class="va">newdata</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="va">newdata</span><span class="op">$</span><span class="va">county_avg_sbp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">county_avg_sbp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">no_weights_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">20</span><span class="op">:</span><span class="fl">60</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">newdata</span><span class="op">$</span><span class="va">county_mean_age</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">sl_model_no_weights</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">with_weights_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">20</span><span class="op">:</span><span class="fl">60</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">newdata</span><span class="op">$</span><span class="va">county_mean_age</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">sl_model_with_weights</span><span class="op">$</span><span class="fu">sl_predictor</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">county_mean_age</span>, y <span class="op">=</span> <span class="va">county_incidence_rate</span>, size <span class="op">=</span> <span class="va">county_person_years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_continuous</a></span><span class="op">(</span></span>
<span>    transform <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/transform_log.html" class="external-link">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">1e5</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">1e5</span>, <span class="fl">1e6</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'100'</span>, <span class="st">'1000'</span>, <span class="st">'100k'</span>, <span class="st">'1m'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    county_mean_age <span class="op">=</span> <span class="fl">20</span><span class="op">:</span><span class="fl">60</span>,</span>
<span>    prediction <span class="op">=</span> <span class="va">no_weights_predictions</span><span class="op">)</span>,</span>
<span>  mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prediction</span>, color <span class="op">=</span> <span class="st">'non-weighted'</span><span class="op">)</span>,</span>
<span>  size <span class="op">=</span> <span class="cn">NULL</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    county_mean_age <span class="op">=</span> <span class="fl">20</span><span class="op">:</span><span class="fl">60</span>,</span>
<span>    prediction <span class="op">=</span> <span class="va">with_weights_predictions</span><span class="op">)</span>,</span>
<span>  mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prediction</span>, color <span class="op">=</span> <span class="st">'weighted'</span><span class="op">)</span>,</span>
<span>  size <span class="op">=</span> <span class="cn">NULL</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'weighted'</span> <span class="op">=</span> <span class="st">'#c54a41'</span>, <span class="st">'non-weighted'</span> <span class="op">=</span> <span class="st">'#2193b3'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">'super_learner() specification'</span>,</span>
<span>       x <span class="op">=</span> <span class="st">'County Avg. Age'</span>,</span>
<span>       y <span class="op">=</span> <span class="st">'County Incidence Rate per 100k Person-Years'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Observation weights change the influence of observations on super_learner() predictions"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="Using-Weights_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://ctesta.com" class="external-link">Christian Testa</a>, <a href="https://nimahejazi.org/" class="external-link">Nima Hejazi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
