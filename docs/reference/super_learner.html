<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Super Learner: Cross-Validation Based Ensemble Learning — super_learner • nadir</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.0/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Super Learner: Cross-Validation Based Ensemble Learning — super_learner"><meta name="description" content="Super learning with functional programming!"><meta property="og:description" content="Super learning with functional programming!"><meta property="og:image" content="https://ctesta01.github.io/nadir/logo.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nadir</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Basic-Examples.html">Basic Examples</a></li>
    <li><a class="dropdown-item" href="../articles/Benchmarking.html">Benchmarking Against `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Binary-and-Multiclass-Outcomes.html">Binary and Multiclass Outcomes</a></li>
    <li><a class="dropdown-item" href="../articles/Clustered-Data.html">Clustered and Dependent Data</a></li>
    <li><a class="dropdown-item" href="../articles/comparison_to_SuperLearner.html">Comparison to `{SuperLearner}` and `{sl3}`</a></li>
    <li><a class="dropdown-item" href="../articles/Creating-Learners.html">Creating Learners</a></li>
    <li><a class="dropdown-item" href="../articles/currying_closures_and_function_factories.html">Currying, Closures, and Function Factories</a></li>
    <li><a class="dropdown-item" href="../articles/Density-Estimation.html">Density Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Doubly-Robust-Estimation.html">Doubly Robust Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Error-Handling.html">Error Handling</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/Guidance-for-Developers.html">Guidance for Developers</a></li>
    <li><a class="dropdown-item" href="../articles/Running-super_learner-in-Parallel.html">Running `super_learner()` in Parallel</a></li>
    <li><a class="dropdown-item" href="../articles/Screeners.html">Screeners</a></li>
    <li><a class="dropdown-item" href="../articles/Survival.html">Survival Analysis via Pooled Logistic Regression</a></li>
    <li><a class="dropdown-item" href="../articles/Using-Weights.html">Using Observation Weights</a></li>
    <li><a class="dropdown-item" href="../articles/Visualizing-Performance.html">Visualizing Performance</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ctesta01/nadir/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Super Learner: Cross-Validation Based Ensemble Learning</h1>
      <small class="dont-index">Source: <a href="https://github.com/ctesta01/nadir/blob/HEAD/R/super_learner.R" class="external-link"><code>R/super_learner.R</code></a></small>
      <div class="d-none name"><code>super_learner.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Super learning with functional programming!</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">super_learner</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">learners</span>,</span>
<span>  <span class="va">formulas</span>,</span>
<span>  y_variable <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_folds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  <span class="va">determine_super_learner_weights</span>,</span>
<span>  continuous_or_discrete <span class="op">=</span> <span class="st">"continuous"</span>,</span>
<span>  <span class="va">cv_schema</span>,</span>
<span>  outcome_type <span class="op">=</span> <span class="st">"continuous"</span>,</span>
<span>  extra_learner_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose_output <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">cluster_ids</span>,</span>
<span>  <span class="va">strata_ids</span>,</span>
<span>  weights <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>Data to use in training a `super_learner`.</p></dd>


<dt id="arg-learners">learners<a class="anchor" aria-label="anchor" href="#arg-learners"></a></dt>
<dd><p>A list of predictor/closure-returning-functions. See Details.</p></dd>


<dt id="arg-formulas">formulas<a class="anchor" aria-label="anchor" href="#arg-formulas"></a></dt>
<dd><p>Either a single regression formula or a vector of regression formulas.</p></dd>


<dt id="arg-y-variable">y_variable<a class="anchor" aria-label="anchor" href="#arg-y-variable"></a></dt>
<dd><p>Typically `y_variable` can be inferred automatically from the `formulas`, but if needed, the y_variable can be specified explicitly.</p></dd>


<dt id="arg-n-folds">n_folds<a class="anchor" aria-label="anchor" href="#arg-n-folds"></a></dt>
<dd><p>The number of cross-validation folds to use in constructing the `super_learner`.</p></dd>


<dt id="arg-determine-super-learner-weights">determine_super_learner_weights<a class="anchor" aria-label="anchor" href="#arg-determine-super-learner-weights"></a></dt>
<dd><p>A function/method to determine the weights for each of the candidate `learners`. The default is to use `determine_super_learner_weights_nnls`.</p></dd>


<dt id="arg-continuous-or-discrete">continuous_or_discrete<a class="anchor" aria-label="anchor" href="#arg-continuous-or-discrete"></a></dt>
<dd><p>Defaults to `'continuous'`, but can be set to `'discrete'`.</p></dd>


<dt id="arg-cv-schema">cv_schema<a class="anchor" aria-label="anchor" href="#arg-cv-schema"></a></dt>
<dd><p>A function that takes `data`, `n_folds` and returns a list containing `training_data` and `validation_data`, each of which are lists of `n_folds` data frames.</p></dd>


<dt id="arg-outcome-type">outcome_type<a class="anchor" aria-label="anchor" href="#arg-outcome-type"></a></dt>
<dd><p>One of 'continuous', 'binary', 'multiclass', or 'density'. <code>outcome_type</code> is used to infer the correct <code>determine_super_learner_weights</code> function if it is not explicitly passed.</p></dd>


<dt id="arg-extra-learner-args">extra_learner_args<a class="anchor" aria-label="anchor" href="#arg-extra-learner-args"></a></dt>
<dd><p>A list of equal length to the `learners` with additional arguments to pass to each of the specified learners.</p></dd>


<dt id="arg-verbose-output">verbose_output<a class="anchor" aria-label="anchor" href="#arg-verbose-output"></a></dt>
<dd><p>If `verbose_output = TRUE` then return a list containing the fit learners with their predictions on held-out data as well as the
prediction function closure from the trained `super_learner`.</p></dd>


<dt id="arg-cluster-ids">cluster_ids<a class="anchor" aria-label="anchor" href="#arg-cluster-ids"></a></dt>
<dd><p>(default: null) If specified, clusters will either be entirely assigned to training or validation (not both) in each cross-validation split.</p></dd>


<dt id="arg-strata-ids">strata_ids<a class="anchor" aria-label="anchor" href="#arg-strata-ids"></a></dt>
<dd><p>(default: null) If specified, strata are balanced across training and validation splits so that strata appear in both the training and validation splits.</p></dd>


<dt id="arg-weights">weights<a class="anchor" aria-label="anchor" href="#arg-weights"></a></dt>
<dd><p>If specified, (per observation) weights are used to
indicate that risk minimization across models (i.e., the meta-learning
step) should be targeted to higher weight observations.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The goal of any super learner is to use cross-validation and a
set of candidate learners to 1) evaluate how the learners perform
on held out data and 2) to use that evaluation to produce a weighted
average (for continuous super learner) or to pick a best learner (for
discrete super learner) of the specified candidate learners.</p>
<p>Super learner and its statistically desirable properties have been written
about at length, including at least the following references:</p>
<p>* &lt;https://biostats.bepress.com/ucbbiostat/paper222/&gt;
  * &lt;https://www.stat.berkeley.edu/users/laan/Class/Class_subpages/BASS_sec1_3.1.pdf&gt;</p>
<p>`nadir::super_learner` adopts several user-interface design-perspectives
that will be useful to know in understanding what it does and how it works:</p>
<p>* The specification of learners should be _very flexible_, really only
  constrained by the fact that candidate learners should be designed
  for the same prediction problem but their details can wildly vary
  from learner to learner.
  * It should be easy to specify a customized or new learner.</p>
<p>`nadir::super_learner` at its core accepts `data`,
a `formula` (a single one passed to `formulas` is fine),
and a list of `learners`.</p>
<p>`learners` are taken to be lists of functions of the following specification:</p>
<p>* a learner must accept a `data` and `formula` argument,
  * a learner may accept more arguments, and
  * a learner must return a prediction function that accepts `newdata` and
produces a vector of prediction values given `newdata`.</p>
<p>In essence, a learner is specified to be a function taking (`data`, `formula`, ...)
and returning a _closure_ (see &lt;http://adv-r.had.co.nz/Functional-programming.html#closures&gt; for an introduction to closures)
which is a function accepting `newdata` returning predictions.</p>
<p>Since many candidate learners will have hyperparameters that should be tuned,
like depth of trees in random forests, or the `lambda` parameter for `glmnet`,
extra arguments can be passed to each learner via the `extra_learner_args`
argument. `extra_learner_args` should be a list of lists, one list of
extra arguments for each learner. If no additional arguments are needed
for some learners, but some learners you're using do require additional
arguments, you can just put a `NULL` value into the `extra_learner_args`.
See the examples.</p>
<p>In order to seamlessly support using features implemented by extensions
to the formula syntax (like random effects formatted like random intercepts or slopes that use the
`(age | strata)` syntax in
`lme4` or splines like `s(age | strata)` in `mgcv`), we allow for the
`formulas` argument to either be one fixed formula that
`super_learner` will use for all the models, or a vector of formulas,
one for each learner specified.</p>
<p>Note that in the examples a mean-squared-error (mse) is calculated on
the same training/test set, and this is only useful as a crude diagnostic to
see that super_learner is working. A more rigorous performance metric to
evaluate `super_learner` on is the cv-rmse produced by cv_super_learner.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>cv_super_learner</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>     glm <span class="op">=</span> <span class="va">lnr_glm</span>,</span></span>
<span class="r-in"><span>     rf <span class="op">=</span> <span class="va">lnr_rf</span>,</span></span>
<span class="r-in"><span>     glmnet <span class="op">=</span> <span class="va">lnr_glmnet</span>,</span></span>
<span class="r-in"><span>     lmer <span class="op">=</span> <span class="va">lnr_lmer</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># mtcars example ---</span></span></span>
<span class="r-in"><span><span class="va">formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  .default <span class="op">=</span> <span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span> <span class="op">+</span> <span class="va">hp</span>, <span class="co"># first three models use same formula</span></span></span>
<span class="r-in"><span>  lmer <span class="op">=</span> <span class="va">mpg</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">cyl</span><span class="op">)</span> <span class="op">+</span> <span class="va">hp</span> <span class="co"># lme4 uses different language features</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># fit a super_learner</span></span></span>
<span class="r-in"><span><span class="va">sl_model</span> <span class="op">&lt;-</span> <span class="fu">super_learner</span><span class="op">(</span></span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">mtcars</span>,</span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">formulas</span>,</span></span>
<span class="r-in"><span>  learners <span class="op">=</span> <span class="va">learners</span>,</span></span>
<span class="r-in"><span>  verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We recommend taking a look at this object, and comparing it to the sole function</span></span></span>
<span class="r-in"><span><span class="co"># returned when verbose = FALSE.  tip: It's the $sl_predictor function in the</span></span></span>
<span class="r-in"><span><span class="co"># verbose output.</span></span></span>
<span class="r-in"><span><span class="va">sl_model</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="compare_learners.html">compare_learners</a></span><span class="op">(</span><span class="va">sl_model</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># iris example ---</span></span></span>
<span class="r-in"><span><span class="va">sl_model</span> <span class="op">&lt;-</span> <span class="fu">super_learner</span><span class="op">(</span></span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">iris</span>,</span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    .default <span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Sepal.Width</span> <span class="op">+</span> <span class="va">Petal.Length</span> <span class="op">+</span> <span class="va">Petal.Width</span>,</span></span>
<span class="r-in"><span>    lmer <span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">~</span> <span class="op">(</span><span class="va">Sepal.Width</span> <span class="op">|</span> <span class="va">Species</span><span class="op">)</span> <span class="op">+</span> <span class="va">Petal.Length</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  learners <span class="op">=</span> <span class="va">learners</span>,</span></span>
<span class="r-in"><span>  verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># produce super_learner predictions and compare against the individual learners</span></span></span>
<span class="r-in"><span><span class="fu"><a href="compare_learners.html">compare_learners</a></span><span class="op">(</span><span class="va">sl_model</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://ctesta.com" class="external-link">Christian Testa</a>, <a href="https://nimahejazi.org/" class="external-link">Nima Hejazi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

